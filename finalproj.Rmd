--- 
title: "2020 U.S. Election Visulizations"
author: "GROUP 10: Jin Qian, Wenjie Zhu, Yibai Liu"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---
```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

# Introduction

The COVID-19 pandemic being the most consequential global event in the year of 2020 has impacted everyone and every country in the world. In an environment of continued uncertainty, the 2020 U.S. Presidential Election . It took over two weeks for the race to be called by the Associated Press. The voting result encaptured many interesting aspects such as the current U.S economic condition, people's expectations on the new ruling party, and politician's response to these new expectations. On the other hand, the worries on the voting fraud and the trustworthy of data outcomes has been a major problem over this entire election, which further obscured the facts behind those numbers. 

Take the above facts into the consideration, it would be helpful to perform an trustful analysis on 2020 presidential election. Our team is going to approach the analysis from a more economical point of view. Some basic questions that we would like to get out from this analysis would be: 

 - How are electoral votes and popular votes different?
 - How much has each campaign raised and spend this year?

We also would like to investigate some more advanced questions such as: 

  - How are electoral votes and popular votes distributed in the country? 
  - Did contributions this year infer the final voting results or form a timeline reflecting on major events happened this year? 
  - What were each campaignâ€™s spending strategies? Were those strategies effective in leading the voting outcome?

To answer those questions, we have collected the presidential committee contribution and disbursement data from [Federal Election Commission](https://www.fec.gov/) as well as the voting outcome from [The Cook Political Report](https://cookpolitical.com/) to perform a cross-reference. In the following chapters, we will perform analysis on those data sets in order to clear the doubts and provide everyone a better insight on current political and economical environment.




<!--chapter:end:index.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data sources

```{r}
library(here)
```

This project uses three major datasets. The primary data sources are [*Federal Election Commission*](http://fec.gov/data/) (FEC) and [*The Cook Political Report*](https://cookpolitical.com/2020-national-popular-vote-tracker) (Cook Political).   

FEC gathers and processes campaign finance data and discloses information about the public funding of US presidential elections. We downloaded the Contribution Receipts data and the Campaign Disbursement data from the FEC website. Cook Political collects and verifies US election returns across the country and is the authoritative source for 2020 Presidential Election voting results. 

## U.S. County Level 2020 Presidential Election Voting Results 

```{r,include=FALSE}
knitr::opts_chunk$set(opts.label="kill_prefix")
DataDescription<- readr::read_csv(here("./data/DatasetDescription.csv"))
DataDescription_add<- readr::read_csv(here("./data/DatasetDescription_add.csv"))
```

**Dataset: 2020_US_State_Level_Presidential_Results.csv**
The dataset contains 21 columns and 61 records about the voting results of 2020 presidential election by US state. This dataset was from FEC. Here we only used 6 columns.

```{r, echo=FALSE, results='asis'}
knitr::kable(DataDescription_add, caption = "Major columns used",
             row.names = F,font_size = 10)
```

**Dataset: 2020_US_County_Level_Presidential_Results.csv**

The dataset contains 10 columns and 3159 records about the voting results of 2020 presidential election by US county. This dataset was exported from [*Tony McGovern, 2020_US_County_Level_Presidential_Results*](https://github.com/tonmcg/US_County_Level_Election_Results_08-20/blob/master/2020_US_County_Level_Presidential_Results.csv). He scraped it from results published by from Fox News, Politico, and the New York Times.



```{r, echo=FALSE, results='asis'}
knitr::kable(DataDescription[1:10, ], caption = "Major columns used",
             row.names = F,font_size = 10)
```

**Issue with this Dataset**

The election results data was collected on Nov.22, 2020, which the results do not reflect on the latest results. The election votes counting is continuing, so we don't get the final results yet. The latest data is not yet open to public.  

## Contribution Receipts

**Dataset: contribution_bind.csv**

The contribution receipts data on [fec.gov](fec.gov) includes all receipts filed by election candidates and committees with records of contributions made by individuals, organizations, and committees. 
 
Due to a huge data volume, we limited the records exported to only those contributions with an amount over or equal to 200 dollars, received within this year, and raised by the committees of two final presidential candidates of 2020 Election. The dataset with filters applied was exported from [here](https://www.fec.gov/data/receipts/?recipient_committee_type=P&data_type=processed&committee_id=C00580100&committee_id=C00703975&two_year_transaction_period=2020&min_date=01%2F01%2F2020&max_date=11%2F03%2F2020&is_individual=true&min_amount=200).

The retrieved dataset has 79 columns and 984,824 records in total. There are 302,731 entries for Trump and 682,093 entries for Biden. 

```{r, echo=FALSE, results='asis'}
knitr::kable(DataDescription[13:27, ], caption = "Major columns used",
             row.names = F,font_size = 10)
```

**Issue with this Dataset**

1. The original dataset is extremely big with over 200 million records, but the majority of them have very small amounts on the receipts, therefore we filtered out records with amounts less than 200 dollars. As a result, the retrieved dataset might not capture information for all contributors, but at the same time it largely eliminates noise that we can focus on contributors who really made significant contributions to support their favorite candidate.  

2. The dataset contains contribution amounts of negatives and zeros, which are probably relate to unsuccessful transfers.

3. Many contributors didn't provide all the information by some reason, so there are missing values and meaningless records in some columns like name, occupation, employer, and even city and states. 

4. Since the information was gathered based on filings of committees and campaigns, the records do not comply with a unified format. For example, the contributor suffix column has records for "JR", "JR.", and "JR.," which are actually the same thing. There are also errors in the spellings of states and cities.

## The Disbursements data

**Dataset: schedule_b-2020-11-08T16_10_30.csv**

The Disbursements data on [fec.gov](fec.gov) includes the operating expenditure records of House and Senate committees, Presidential committees, and PAC and Party committees since 2003. 

For this analysis, we filtered the data to focus on the records from the presidential committees of 2020 Election, which the disbursement dates are from 01/01/2020 to 11/03/2020, to be consistent with the scope of the contribution receipt dataset. The dataset with filters applied was exported from [FEC Official Database](https://www.fec.gov/data/disbursements/?spender_committee_type=P&data_type=processed&min_date=01%2F01%2F2020&max_date=11%2F03%2F2020). The retrieved dataset has 260,587 records and 78 columns.

```{r, echo=FALSE, results='asis'}
knitr::kable(DataDescription[30:39, ], caption = "Major columns used",
             row.names = F,font_size = 10)
```

**Issue with this Dataset**

1. The raw dataset we retrieved contains 260,587 entries as of Nov 18th, 2020, but the data is still getting updated with additive filings of previous disbursements being archived. The total number of records is subject to change, but the change will be trivial compared to the size of the entire dataset. Although this will not affect our analysis or overall conclusion, it would be worth paying attention to the data incompleteness here.

<!--chapter:end:02-data.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data transformation

```{r, message=FALSE, warning=FALSE}
library(here)
library(readr)
library(tidyverse)
library(socviz)
```

## Election Result Data Transformation 

We used historical U.S. presidential election data provided in the `socviz` library, but since the data for 2016 was provisional, we updated the [2016 data](https://en.wikipedia.org/wiki/2016_United_States_presidential_election) and also added the 2020 election data for our analysis.

```{r}
# Update data
data(elections_historic)
elections_historic_new <- elections_historic 
elections_historic_new$ec_pct[elections_historic_new$year == 2016] <- 304/(304+227)
elections_historic_new$popular_pct[elections_historic_new$year == 2016] <- 0.461
elections_historic_new$popular_margin[elections_historic_new$year == 2016] <- -0.021

elections_historic_full <- elections_historic_new

elections_historic_new <- elections_historic_new %>%
  select(c(win_party,popular_pct,ec_pct,winner_label))

# add data for 2020  
data2020 <- data.frame(win_party = 'Dem.',popular_pct = 0.514,ec_pct = 306/(306+232), winner_label = 'Biden 2020')

elections_historic_new <- rbind(elections_historic_new,data2020)

write.csv(elections_historic_new, file = here("data", "clean", "elections_historic_new.csv"),row.names=FALSE)
```

Also, to make comparison of the share of electoral college vote between *Dem.* and *Rep.* more convenience, we mutated and filterd the dataset to the following one:

```{r, echo=FALSE, results='asis'}
knitr::kable(data.frame(
                description = c('Year','Votes_PERCEN','Party'),
                category = c("Which election year?", "Votes percentage for president","Winner. Dem or Rep?")
              ), 
             col.names = c('Column','Description'),
             row.names = F,font_size = 10)
```

```{r}
t_win <- elections_historic_full %>%
  filter(win_party %in% c("Dem.","Rep.")) %>%
  select(year,ec_pct,win_party)

t_los <- t_win %>%
  mutate(ec_pct = 1 - ec_pct) %>%
  mutate(win_party = ifelse(t_win$win_party == 'Dem.', 'Rep.', 'Dem.')) %>%
  select(year,ec_pct,win_party)

compare <- rbind(t_win,t_los) 
names(compare) <- c('Year','Votes_PERCEN','Party')

write.csv(compare, file = here("data", "clean", "compare.csv"),row.names=FALSE)
```

## Contribution Data Transformation

For the contributions receipt dataset, we extracted only relevant columns as described in Data Sources Chapter. We changed the data types for several columns to factorize categorical variables like `committee_name` and to store `contribution_receipt_date` in a datetime format for later visualizations. We filtered the `contributor_state` column to only keep the 50 states of the US plus D.C. and eliminated noise from funds raised from foreign countries. Also, we unified different formats in the `contributor_suffix` column to eliminate the redundant factor levels. To better scale the contributions, we focused only on individual contributions, thus we applied the `entity_type == "IND"` to get rid of the contributions from committees, PACs, and organizations. 
To save file-reading time and to meet analysis and visualization needs, we made multiple aggregations on different dimensions. We derived a data frame *contribution_by_date* from aggregating the processed data by `contribution_receipt_date`, and the sum of `contribution_receipt_amount` was calculated for this aggregated view. Additionally, we extracted the contributors' job titles from the column `contributor_occupation`, cleaned the texts following steps including: 
  - Excluded records of uninformational or ineffective strings. For example, we got rid of records equal to "INFORMATION REQUESTED", "-", "NA", "UNKNOWN", etc.
  - Gathered column values to a single string separated by blank spaces. We saved some two-word job titles like "SELF EMPLOYED" and "REAL ESTATE" with underlines to avoid them being separated apart.
  - Inserted spaces to divide words that were sticked together. For example, records like "WRITEREDITORTEACHER" were converted to "WRITER EDITOR TEACHER" with spaces in between.
  - Split the string to a vector of single words.
  - Removed unnecessary punctuations and numbers.
  - Fixed detectable typos and abbreviations
  - Removed uninformational words stored in the [stop words](https://www.rdocumentation.org/packages/tidytext/versions/0.2.6/topics/stop_words) dataset of package `tidytext`. For example, words like "the", "of", and "and" do not add any insight but will distort the frequency distribution. 
Finally, the counts for each unique word were calculated and saved in a separate .csv file.

```{r}
contributions1 <- readr::read_csv(here("./data/raw/contribution_bind.csv"))

# Extract columns
DataDescription<- readr::read_csv(here("./data/DatasetDescription.csv"))
columns <- as.vector(DataDescription[13:26,1])

contributions1<- contributions1 %>%
  select(columns[1:14])

# Change data types and factorize categorical variables
contributions1$committee_name <- as.factor(contributions1$committee_name)
contributions1$committee_name <- fct_recode(contributions1$committee_name,TRUMP = "DONALD J. TRUMP FOR PRESIDENT, INC.",BIDEN = "BIDEN FOR PRESIDENT")
contributions1$contribution_receipt_date <- as.Date(contributions1$contribution_receipt_date, format = "%m/%d/%y")

# Filter contributor_state
state<- c("AL","AK","AZ","AR","CA","CO","CT","DE","DC","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY")

contributions1 <- contributions1[contributions1$contributor_state %in% state,]

# Update suffix
contributions1$contributor_suffix%>%
  unique()
contributions1<- contributions1 %>% 
  mutate(contributor_suffix = ifelse(contributor_suffix == "JR.", "JR", contributor_suffix))
contributions1<- contributions1 %>% 
  mutate(contributor_suffix = ifelse(contributor_suffix == "JR.,", "JR", contributor_suffix))
contributions1<- contributions1 %>% 
  mutate(contributor_suffix = ifelse(contributor_suffix == "7/18/", "", contributor_suffix))
contributions1<- contributions1 %>% 
  mutate(contributor_suffix = ifelse(contributor_suffix == "SR.", "SR", contributor_suffix))
contributions1<- contributions1 %>% 
  mutate(contributor_suffix = ifelse(contributor_suffix == "M.D.", "MD", contributor_suffix))
contributions1<- contributions1 %>% 
  mutate(contributor_suffix = ifelse(contributor_suffix == "ESQ.", "ESQ", contributor_suffix))

#filter individual contributions
contributions1<- contributions1[contributions1$entity_type == "IND",]

write.csv(contributions1, file = here("data", "clean", "contribution_processed.csv"),row.names=FALSE)

#Aggregations
contribution_by_date <-contributions1[order(contributions1$contribution_receipt_date, decreasing= F),] %>% 
  select(committee_name,contribution_receipt_date,contribution_receipt_amount) %>%
  group_by(contribution_receipt_date,committee_name) %>%
    summarise(Total = sum(contribution_receipt_amount))

write.csv(contribution_by_date, file = here("data", "clean", "contribution_by_date.csv"),row.names=FALSE)
```

```{r, eval = FALSE, echo=FALSE}
# Define a function to extract occupations

GetOccupation <- function(name){
  # Filter data by Candidate
  if (name == 'BIDEN'){
    contributions1 <- contributions1[contributions1$committee_name == 'BIDEN',]
  } else if (name == 'TRUMP'){
    contributions1 <- contributions1[contributions1$committee_name == 'TRUMP',]
  }
  
  # Get rid of ineffective string records
  INEFFECTIVE <- c("INFORMATION REQUESTED","INFORMATION REQUESTED PER BEST EFFORTS","-","--","NA","UNKNOWN")
  contributions1 <- contributions1 %>%
      mutate(contributor_occupation=replace(contributor_occupation,
                    contributor_occupation %in% INEFFECTIVE, ''))
                    
  # Extract occupation
  occupation <- contributions1 %>% select(contributor_occupation)
  occupation <- drop_empty_row(occupation)
  
  # Keep some two-word occupations to avoid them from being separated apart
  occupation[occupation=="NOT EMPLOYED"] <-"NOT_EMPLOYED"
  occupation[occupation=="VICE PRESIDENT"] <-"VICE_PRESIDENT"
  occupation[occupation=="SELF EMPLOYED"] <-"SELF_EMPLOYED"
  occupation[occupation=="REAL ESTATE"] <-"REAL_ESTATE"
  
  # Count the frequency
  occupation %>% count(contributor_occupation, name = "freq") %>% arrange(desc(freq))
  
  # Gather column values to a single string separated by a blank space
  oc_str<- occupation %>% pull(contributor_occupation) %>% paste(collapse = " ")
  
  # Divide words by a blank space
  patterns <- c("ATTORNEY","CONSULTANT","WRITER","PROFESSOR","DIRECTOR",
                "PHYSICIAN","CEO","ACTOR","ENGINEER","SELF_EMPLOYED",
                "VP","VICE_PRESIDENT","REAL_ESTATE","TEACHER")
  replacements <- c(" ATTORNEY "," CONSULTANT "," WRITER "," PROFESSOR "," DIRECTOR ",
                    " PHYSICIAN "," CEO "," ACTOR "," ENGINEER "," SELF_EMPLOYED ",
                    " VICE_PRESIDENT "," VICE_PRESIDENT "," REAL_ESTATE "," TEACHER ")
  for(i in 1:length(patterns)){
       oc_str <- gsub(patterns[i], replacements[i],oc_str)
  }
  
  # Split the string
  oc_str_sp<- unlist(strsplit(oc_str, "\\s+"))
  # Remove punctuation marks
  oc_str_sp <- gsub("[[:punct:]]", "", oc_str_sp)
  # Remove all rows starting with a number
  oc_str_sp <- grep('^[A-Z]', oc_str_sp, value=TRUE)
  
  # Fix Typos for top counts occupations
  oc_str_sp[grep('ACCOUNT|ACCNTNT|ACCOU|ACCT|ACOUNT', oc_str_sp)] <- "ACCOUNTANT"
  oc_str_sp[grep('ADMIN|ADMIST|ADMIIN|ADMN', oc_str_sp)] <- "ADMINISTRATOR"
  oc_str_sp[grep('RETIRED', oc_str_sp)] <- "RETIRED"
  oc_str_sp[grep('CONSULTING', oc_str_sp)] <- "CONSULTANT"
  oc_str_sp[grep('TECHNIC', oc_str_sp)] <- "TECHNICIAN"
  oc_str_sp[grep('WRIT', oc_str_sp)] <- "WRITER"
  oc_str_sp[grep('VETERNARIAN|VETERINARY', oc_str_sp)] <- "VETERINARIAN"
  oc_str_sp[grep('THERAP', oc_str_sp)] <- "THERAPIST"
  oc_str_sp[grep('TECHNOLOG|TECHS', oc_str_sp)] <- "TECH"
  oc_str_sp[grep('TEACH', oc_str_sp)] <- "TEACHER"
  oc_str_sp[grep('SEFTEMPLOYED|SELFEMPLOYE|SELEMPLOYED', oc_str_sp)] <- "SELFEMPLOYED"
  oc_str_sp[grep('ENGIINEERN|ENGIN|ENGNEER|ENIGEER|ENGENEER|ENGI|ENGNINEER|ENGONEER|ENIGNEER|ENINGEER', oc_str_sp)] <- "ENGINEER"
  oc_str_sp[grep('ENTREP|ENTERPRENEUR|ENTRREPRENEUR|ENTEREPRENEUR|ENTRPRENEUR', oc_str_sp)] <- "ENTREPRENEUR"
  oc_str_sp[grep('ATTO|ATTR|ATTIORNEY|ATTAORNEY|ATTIRNEY|ATTPRNEY|ATTTORNEY', oc_str_sp)] <- "ATTORNEY"
  oc_str_sp[grep('PHYSICI|PHYSCIAN|PHYISICIAN|PHYCISIAN|PHYSITION|PHYSCIAN|PHYSICAIN|PHYISICIAN|PHYSIAN|PHYSISIAN|PHYSICAN|PHYSISCIAN|PHYI|PHYSYCIAN|PHYSSICIAN|PHYSIVIAN|PHYSIACIAN', oc_str_sp)] <- "PHYSICIAN"
  oc_str_sp[grep('PROFESSO|PROFOESSOR|PROFESSPR|PROFESSIR|PROFFESE|PROFESSE|PROFESSSOR|PROFSSOR|PROFESOR|PROFESSR', oc_str_sp)] <- "PROFESSOR"
  
  #Build a data frame
  oc_df <- as.data.frame(oc_str_sp)
  
  # Remove all unnecessary words stored in the stop_words dataset
  data(stop_words)
  oc_df <- oc_df %>% 
    anti_join(stop_words %>% mutate(word=toupper(word)), by = c("oc_str_sp" = "word"))

  # Get the frequency table and pick top 50 words
  oc_df$oc_str_sp <- as.factor(oc_df$oc_str_sp)
  oc_count <- oc_df %>% count(oc_str_sp, name = "freq") %>% 
    filter(freq > 1) %>% 
    arrange(desc(freq)) %>% 
    head(50)
  
  # Replace underlines with blank spaces
  oc_count$oc_str_sp <- oc_count$oc_str_sp %>% 
      str_replace("NOTEMPLOYED","NOT EMPLOYED") %>% 
      str_replace("SELFEMPLOYED","SELF EMPLOYED") %>% 
      str_replace("VICEPRESIDENT","VICE PRESIDENT") %>%
      str_replace("REALESTATE","REAL ESTATE")
  
  # Save as a csv. file locally
  write.csv(oc_count, file=glue::glue("~/R/occupation_{name}_count.csv"),row.names = FALSE)
  
  return(oc_count)
}

# Get contributor occupations
oc_biden_count <- GetOccupation("BIDEN")
oc_trump_count <- GetOccupation("TRUMP")
```


## Disbursement Data Transformation
The first step we did is to extract the necessary columns that are mentioned in the previous chapter. Then we noticed that in the `disbursement_purpose_category`, there is a `OTHER` top coding is dominant the dataset, hence it would not provide us lots of interesting information to analyze. Below is the original data distribution for the `disbursement_purpose_category` column:
```{r}
# Import data from csv
exp_raw <- readr::read_csv(here("./data/raw/schedule_b-2020-11-18T20_02_30.csv"))

# Extract specific columns
exp_processed <- exp_raw %>% 
  select(committee_name, disbursement_description, disbursement_date, disbursement_amount,
         disbursement_purpose_category, recipient_city, recipient_zip, recipient_state, recipient_name)

# Convert to correct data type and factor the data if necessary
exp_processed$disbursement_purpose_category <- factor(exp_processed$disbursement_purpose_category)

# Visualize some important data columns
ggplot(exp_processed) + 
  geom_bar(aes(y=fct_relevel(fct_infreq(disbursement_purpose_category) %>% fct_rev(), "OTHER"))) + 
  xlab("Count") +
    ylab("Disbursement Purpose") + 
  ggtitle("Distribution of disbursement_purpose_category") +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        plot.subtitle = element_text(face = "bold", color = "grey35"),
        plot.caption = element_text(color = "grey68"),
        legend.position="bottom")
```

But since we have another column which is the disbursement_description, we can use this information to decode this top code. We examined the frequently mentioned terms in `disbursement_description` among those marked as `OTHER` and manually categorize them into existing or new categories that would fit the record type better. Below is a conversion table that we used to convert the columns. The pattern we are looking for in the description ar based on high frequent terms as well as their word stems and abbreviations. The conversion are done based on the order of this list. 
```{r, echo=FALSE, results='asis'}
knitr::kable(data.frame(
                description = c("BANK|PROCESS","CONSULT",
                                "SLRY|SALARY|OFFICE|PAYROLL|PYROLL|PHONE|RENT|SOFTWARE|COMPUTER",
                                "MARKET|MARKETING|ADVERTISING","TRAVEL|TRANSPORT","STAG|STAGING|SHIP",
                                "EVENT|CATER|UTIL", "CONTRIBUTION", "REFUND|MILEAGE|REIMBURSE"),
                category = c("BANKING", "CONSULTING", "ADMINISTRATIVE", "ADVERTISING",
                             "TRAVEL", "MATERIALS", "EVENTS", "CONTRIBUTIONS", "REFUNDS")
              ), 
             col.names = c('Category Description','New Category'),
             caption = "Disbursement Description to Category Conversion Table",
             row.names = F,font_size = 10)
```

```{r}
# label rows that will be changed before undo top coding 
exp_processed <- 
  transform(exp_processed, from_other=ifelse(disbursement_purpose_category=='OTHER', TRUE, FALSE))

# Add more factor levels to describe the purpose better
levels(exp_processed$disbursement_purpose_category) <-
  c(levels(exp_processed$disbursement_purpose_category), "BANKING", "CONSULTING")

# Decode disbursement_purpose_category based on the description
exp_processed[grepl("BANK|PROCESS",exp_processed$disbursement_description, ignore.case=T) &
  exp_processed$disbursement_purpose_category == "OTHER", ]$disbursement_purpose_category <- "BANKING"

exp_processed[grepl("CONSULT",exp_processed$disbursement_description, ignore.case=T) &
  exp_processed$disbursement_purpose_category == "OTHER", ]$disbursement_purpose_category <- "CONSULTING"

exp_processed[grepl("SLRY|SALARY|OFFICE|PAYROLL|PYROLL|PHONE|RENT|SOFTWARE|COMPUTER",
        exp_processed$disbursement_description, ignore.case=T) &
    exp_processed$disbursement_purpose_category == "OTHER", ]$disbursement_purpose_category <- "ADMINISTRATIVE"

exp_processed[grepl("MARKET|MARKETING|ADVERTISING", exp_processed$disbursement_description, ignore.case=T) &
    exp_processed$disbursement_purpose_category == "OTHER", ]$disbursement_purpose_category <- "ADVERTISING"

exp_processed[grepl("TRAVEL|TRANSPORT", exp_processed$disbursement_description, ignore.case=T) &
  exp_processed$disbursement_purpose_category == "OTHER", ]$disbursement_purpose_category <- "TRAVEL"

exp_processed[grepl("STAG|STAGING|SHIP", exp_processed$disbursement_description, ignore.case=T) & 
  exp_processed$disbursement_purpose_category == "OTHER", ]$disbursement_purpose_category <- "MATERIALS"

exp_processed[grepl("EVENT|CATER|UTIL",exp_processed$disbursement_description, ignore.case=T) &
  exp_processed$disbursement_purpose_category == "OTHER", ]$disbursement_purpose_category <- "EVENTS"

exp_processed[grepl("CONTRIBUTION", exp_processed$disbursement_description, ignore.case=T) &
  exp_processed$disbursement_purpose_category == "OTHER", ]$disbursement_purpose_category <-"CONTRIBUTIONS"

exp_processed[grepl("REFUND|MILEAGE|REIMBURSE", exp_processed$disbursement_description, ignore.case=T) &
  exp_processed$disbursement_purpose_category == "OTHER", ]$disbursement_purpose_category <-"REFUNDS"
```

Here is the distribution after undo the top coding:
```{r}
ggplot(exp_processed) + 
  geom_bar(aes(y=fct_relevel(fct_infreq(disbursement_purpose_category) %>% fct_rev(), "OTHER"))) + 
  labs(x="Count", y="Disbursement Purpose",
       title="Distribution of disbursement_purpose_category") +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        plot.subtitle = element_text(face = "bold", color = "grey35"),
        plot.caption = element_text(color = "grey68"),
        legend.position="bottom")
```

Now, the top coding category is less significant than before. We perform our further analysis based on this cleaned data set.
```{r}
write.csv(exp_processed, file = here("data", "clean", "disbursement_processed.csv"),row.names=FALSE)
```



<!--chapter:end:03-cleaning.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Missing values

```{r, message=FALSE, warning=FALSE}
library(here)
library(readr)
library(tidyverse)
library(devtools)
#install_github("njtierney/naniar")
library(naniar)
```

## Contribution Receipt Dataset
The election voting results data and the disbursements data do not have missing values, however, the contribution receipts dataset have 275 values missed in some columns.

```{r, echo = F, message=F}
# Import data from csv
contribution_processed <- readr::read_csv(here("./data/raw/contribution_processed.csv"))

#n_miss(contribution_processed)
#pct_miss(contribution_processed)
#n_complete(contribution_processed)

knitr::kable(colSums(is.na(contribution_processed)) %>% sort(decreasing = TRUE) %>% head(), caption = "Missing values",align = "l",full_width = F,table.attr = "style='width:30%;'")

gg_miss_upset(contribution_processed)
```

In the processed contributions dataset, missing values only take 0.21% of the entire dataset with 946,704 observations of 14 attributes. As shown in the table and the upset plot above, missing values of the contributions dataset most frequently appear in columns including `contributor_employer`, `contributor_zip`, and `contributor_occupation`.
The most popular pattern of missingness is only missing the contributor employer information, which 143 entries share this pattern. Besides there are also 35 entries missing both occupation and employer information, and 34 entries missing zip code information. 

<!--chapter:end:04-missing.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Results

```{r, message=FALSE, warning=FALSE, echo=FALSE}
library(choroplethr)
library(d3treeR)
library(d3r)
library(gganimate)
library(GGally)
library(gridExtra)
library(HH)
library(here)
library(highcharter)
library(MASS)
library(parcoords)
library(plotly)
library(readr)
library(scales)
library(stringr)
library(tidyverse)
library(treemap)
library(usdata)
```

## Election Vote Results Visualizations
### State-level

```{r}
# load packages
library(here)
library(tidyverse)
library(statebins)
library(usmap)
library(ggplot2)
library(dplyr)
library(plyr)
library(socviz)
library(ggrepel)
library(readr)
library(ggthemes)
library(gifski)
library(gganimate)
library(directlabels)
library(png)
#library(transformr)
library(grid)

# load cleaned dataset
president2020 <- readr::read_csv(here("./data/clean/president2020.csv"))
```

```{r, fig.width=20, fig.height=6}
# final results (1205)
president2020 %>%
    mutate(value = ifelse(dem_votes>rep_votes,'Biden','Trump')) %>%
    statebins(
        font_size=4, dark_label = "white", light_label = "white",
        ggplot2_scale_function = scale_fill_manual,
        name = "Winner",
        values = c(Trump = "darkred", Biden = "darkblue"),
        round = TRUE, radius=grid::unit(16, "pt"), direction = 1
    ) +
    theme_statebins()+
  labs(title = "2020 US Election Results by State",caption = "Source: cookpolitical", fill = NULL)+
  theme(plot.title = element_text(face = "bold"),
        plot.caption = element_text(color = "grey68"),
        legend.position="bottom",
        axis.text.y = element_blank())

# Note: direction = 1 switches the order of the fill scale 
# so darker shades represent higher illiteracy rates
# (The default is -1).
```

### County-level
Thanks again for the great job by [*Tony McGovern*](https://github.com/tonmcg/US_County_Level_Election_Results_08-20/blob/master/2020_US_County_Level_Presidential_Results.csv)
```{r, message=FALSE,fig.width=20, fig.height=6}
County2020 <- read_csv('https://raw.githubusercontent.com/tonmcg/US_County_Level_Election_Results_08-20/master/2020_US_County_Level_Presidential_Results.csv')


# *per_dem* and *per_gop* refer to the percentage of votes going to Democrats and Republicans respectively.
# *diff* represents the absolute difference between Republican votes - Democrat votes.
# *per_point_diff* represents this difference as a percentage of total votes.

flow_T <- County2020 %>%
  select(fips, diff)
         
# Graph Highchart
highchart(type="map") %>%
hc_title(text = "2020 US Election Results: Absolute Difference") %>%
  hc_subtitle(text = "Double click the state area to zoom in") %>%
  hc_add_series_map(uscountygeojson, flow_T,
    name = "Votes_gop - Votes_dem",
    value = "diff", joinBy = "fips",
    dataLabels = list(
       enabled = TRUE,
       format = "{point.properties.postalcode}"
     )) %>%
   hc_colorAxis(minColor = "white", maxColor = "red") %>%
   hc_legend(valueDecimals = 0, valueSuffix = "%") %>%
   hc_mapNavigation(enabled = TRUE)
```

If we simply compare the area, we may conclude that Trump will win this election. However, don't forget electoral votes are related to population. 

### Time-level

In this part, I will compare popular vote and electoral college vote from 1824 to 2020 (Note that **Data for 2020 are provisonal**, collected in 5 Dec). *It's possible the candidate with the most votes from the public won't be the winner. This is because the president is not chosen directly by the voters, but what's known as the electoral college. (This explained by [BBC](https://www.bbc.com/news/world-us-canada-53558176) )*

```{r,fig.width=20, fig.height=6}
# Code reference: https://socviz.co/workgeoms.html#workgeoms
# HIGHLY recommended this book!! Really APPRECIATE:)

elections_historic_new <- readr::read_csv(here("./data/clean/elections_historic_new.csv"))

# plot
ggplot(elections_historic_new, aes(x = popular_pct, 
                                   y = ec_pct,
                                   label = winner_label))+
  geom_hline(yintercept = 0.5, size = 1.4, color = "gray80")+
  geom_vline(xintercept = 0.5, size = 1.4, color = "gray80")+
  geom_point(aes(colour = factor(win_party))) +
  geom_text_repel(size = 2) + # deal with overlapping labels
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(labels = scales::percent) +
  annotate(geom = "rect", xmin = 0.37, xmax = 0.497, ymin = 0.51, ymax = 0.85, fill = "red", alpha = 0.2) + 
  annotate(geom = "text", x = 0.35, y = 0.9, label = "Electoral vote is high \nbut with low share of popular vote", hjust = 0)+
  labs(x = "Winner's share of popular vote", 
       y = "Winner's share of electoral college vote", 
       title = "Presidential Elections: Popular & Electoral College Margins", subtitle = "From 1824 to 2020(Data for 2020 are provisional)",
       caption = "Source: socviz::elections_historic & google", fill = "Party affiliation of winner")+
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        plot.subtitle = element_text(face = "bold", color = "grey35"),
        plot.caption = element_text(color = "grey68"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="bottom")
```

From this plot, we can see: 

- Ideally, we may think the president also have high share of popular vote. Those data in the red rectangular shows not this case. This can be explained by [how the US presidential election works](https://en.wikipedia.org/wiki/United_States_presidential_election).

- Adams 1824 may be regarded as an outlier. However, after looking up Wiki, He is actually from Democratic-Republican Party.
- Finally, I can regard Roosevelt as an outstanding candidate since his electoral vote and popular vote are very high.

\n
Finally, we compare the share of electoral college vote between *Dem.* and *Rep.*.
```{r}
compare <- readr::read_csv(here("./data/clean/compare.csv"))

# plot
p <- ggplot(compare, aes(Year, Votes_PERCEN, frame = Year, size = Votes_PERCEN, group = Party,colour = Party)) +
  geom_point()+
  scale_color_manual(values=c("#19609F","#CB1C2A"))+
  transition_time(Year) +
  shadow_wake(wake_length = 0.05, alpha = FALSE) +
  labs(x = "", y = "", 
      title = "Presidential Elections:The Share of Electoral Votes for Dem. and Rep. Respetively", subtitle = "Year : {frame_time} (Data for 2020 are provisional)",
       caption = "Source: socviz::elections_historic & google", fill = NULL)+
  #coord_cartesian(clip = 'off') + 
  #ease_aes('cubic-in-out')+
  theme_classic()

animate(p, fps = 3)
```


From this plot, we can see: Excluding year ftom 1875-1900, the votes percentage difference is relatively huge.

## Contribution Receipts Data Analysis
### Contributions Overview
```{r, echo=FALSE}
# Read the datasets
  # Contribution summary by state
contrib_zip <- readr::read_csv(here("data", "clean", "Contributions_by_3Zip.csv"))

  # Population and registered Voters in 2020 by state
voters_state <- readr::read_csv(here("data", "clean", "RegisteredVotersByState.csv"))

# All candidates
df_all <- contrib_zip[contrib_zip$CANDIDATE_ID=="P00000001" & 
              contrib_zip$ZIP_3=="STATE TOTAL",] %>%
  dplyr::rename(ALL_RECEIPT_AMOUNT = CONTRIB_RECEIPT_AMOUNT)
	
# Biden = P80000722
df_biden <- contrib_zip[contrib_zip$CANDIDATE_ID=="P80000722" & 
              contrib_zip$ZIP_3=="STATE TOTAL",]%>%
  dplyr::rename(BIDEN_RECEIPT_AMOUNT = CONTRIB_RECEIPT_AMOUNT)
# Trump = P80001571
df_trump <- contrib_zip[contrib_zip$CANDIDATE_ID=="P80001571" & 
              contrib_zip$ZIP_3=="STATE TOTAL",] %>%
  dplyr::rename(TRUMP_RECEIPT_AMOUNT = CONTRIB_RECEIPT_AMOUNT)

# Join with state populations
data("statepop")
statepop1 <- statepop[,c(1:3)] %>%
  left_join(voters_state[,c(1:4)],by = c("full" = "State" )) %>%
  left_join(df_all[,c(3,6)], by = c("abbr" = "CONTRIB_STATE")) %>%
  left_join(df_biden[,c(3,6)], by = c("abbr" = "CONTRIB_STATE")) %>%
  left_join(df_trump[,c(3,6)], by = c("abbr" = "CONTRIB_STATE")) 


# Calculate contribution amounts per registered voter of each state
statepop1 <- statepop1 %>%
  mutate(ALL_CONTRIB_PP = round(ALL_RECEIPT_AMOUNT/totalRegistered, 2))%>%
  mutate(BIDEN_CONTRIB_PP = round(BIDEN_RECEIPT_AMOUNT/totalRegistered, 2))%>%
  mutate(TRUMP_CONTRIB_PP = round(TRUMP_RECEIPT_AMOUNT/totalRegistered, 2))

#remove(voters_state, statepop, df_trump, df_biden, df_all)
```

#### Total Contributions by State
```{r, echo=FALSE}
# All states
data("usgeojson", package = "highcharter")
highchart() %>%
hc_title(text = "Total Contributions to All Presidential Candidates 2020 By State") %>%
  hc_subtitle(text = "Double click the state area to zoom in") %>%
  hc_add_series_map(usgeojson, statepop1,
    name = "Total Contributions",
    value = "ALL_RECEIPT_AMOUNT", joinBy = c("postalcode", "abbr"),
    dataLabels = list(
       enabled = TRUE,
       format = "{point.properties.postalcode}"
     ),
    tooltip = list(
      valueDecimals = 0,
      valuePrefix = "$",
      valueSuffix = " USD"
     )
   ) %>%
   hc_colorAxis(minColor = "white", maxColor = "orange") %>%
   hc_legend(valueDecimals = 0, valueSuffix = "%") %>%
   hc_mapNavigation(enabled = TRUE) 
```

As shown in the above map, California has contributed the most to all presidential candidates in 2020 US Election, which exceeded 260 million US dollars. New York, Texas, and Florida also made significant contributions. However, some states like Wyoming and West Virginia only contributed less than 30 million US dollars.

```{r, echo=FALSE}
# Biden
p1<- statepop1 %>% arrange(desc(BIDEN_RECEIPT_AMOUNT)) %>% head(5) %>% 
  mutate(BIDEN_RECEIPT_AMOUNT = round(BIDEN_RECEIPT_AMOUNT/1000000,3)) %>%
  ggplot(aes(x=reorder(abbr, BIDEN_RECEIPT_AMOUNT, median), y=BIDEN_RECEIPT_AMOUNT)) +
    geom_bar(stat="identity", fill="dodgerblue3") +
    geom_text(aes(label=BIDEN_RECEIPT_AMOUNT), hjust=1.2, color="white", size=3.5) +
    coord_flip() +
    # formatting
    ggtitle("Joe Biden") +
    labs(y = "Contribution Amount (Million $)", x = "State",caption = " ") +
    theme_minimal() +
    theme(plot.title = element_text(size = 11,face = "bold", color = "grey35"),
        plot.caption = element_text(color = "grey68"))

# Trump
p2<- statepop1 %>% arrange(desc(TRUMP_RECEIPT_AMOUNT)) %>% head(5) %>% 
  mutate(TRUMP_RECEIPT_AMOUNT = round(TRUMP_RECEIPT_AMOUNT/1000000,3)) %>%
  ggplot(aes(x=reorder(abbr, TRUMP_RECEIPT_AMOUNT, median), y=TRUMP_RECEIPT_AMOUNT)) +
    geom_bar(stat="identity", fill="firebrick2") +
    geom_text(aes(label=TRUMP_RECEIPT_AMOUNT), hjust=1.2, color="white",size=3.5) +
    coord_flip() +
    # formatting
    ggtitle("Donald Trump") +
    labs(y = "Contribution Amount (Million $)", x = " ",caption = "Source: fec.gov") +
    theme_minimal() +
    theme(plot.title = element_text(size = 11, face = "bold", color = "grey35"),
        plot.caption = element_text(color = "grey68"))

# Plot in a grid
grid.arrange(p1, p2, ncol=2, nrow=1,
     top = textGrob("Contributions to Presidential Candidates of 2020 US Election\nTotal Contributions Ranked by State",gp=gpar(fontsize=13, fontface = "bold")))

```

The bar chart above focuses on the total amounts raised by the final presidential candidates Joe Biden and Donald Trump, and it displays top 5 states that contributed the most to each candidate. Joe Biden received  solid support from California and New York which contributed 127M dollars and 63M dollars respectively, more than twice as contributed to Donald Trump. Donald Trump raised significant amounts from Texas and Florida, and these are consistent with the final voting results.

#### Contributions Per Registered Voter by State
```{r, echo=FALSE}
# Biden
p3<- statepop1 %>% arrange(desc(BIDEN_CONTRIB_PP)) %>% head(5) %>% 
  ggplot(aes(x=reorder(abbr, BIDEN_CONTRIB_PP, median), y=BIDEN_CONTRIB_PP)) +
    geom_bar(stat="identity", fill="dodgerblue3") +
    geom_text(aes(label=BIDEN_CONTRIB_PP), hjust=1.2, color="white", size=3.5) +
    coord_flip() +
    # formatting
    ggtitle("Joe Biden") +
    labs(y = "Contribution Amount (US Dollar)", x = "State",caption = " ") +
    theme_minimal() +
    theme(plot.title = element_text(size = 11,face = "bold", color = "grey35"),
        plot.caption = element_text(color = "grey68"))

# Trump
p4<- statepop1 %>% arrange(desc(TRUMP_CONTRIB_PP)) %>% head(5) %>% 
  ggplot(aes(x=reorder(abbr, TRUMP_CONTRIB_PP, median), y=TRUMP_CONTRIB_PP)) +
    geom_bar(stat="identity", fill="firebrick2") +
    geom_text(aes(label=TRUMP_CONTRIB_PP), hjust=1.2, color="white", size=3.5) +
    coord_flip() +
    # formatting
    ggtitle("Donald Trump") +
    labs(y = "Contribution Amount (US Dollar)", x = " ",caption = "Source: fec.gov") +
    theme_minimal() +
    theme(plot.title = element_text(size = 11, face = "bold", color = "grey35"),
        plot.caption = element_text(color = "grey68"))

# Plot in a grid
grid.arrange(p3, p4, ncol=2, nrow=1,
     top = textGrob("Contributions to Presidential Candidates of 2020 US Election\nContributions Per Registered Voter Ranked by State",gp=gpar(fontsize=13, fontface = "bold")))

```

If we instead take into account the registered voters in each state and calculate contributions per registered voter, we found that District of Columbia has the highest average contribution to Biden, which is 37 dollars per registered voter, way more than other states. This is likely due to a smaller population thereby fewer registered voters in DC. In addition, Wyoming surprisingly has contributed the most to Trump on an average level, and a possible reason is that the percentage of registered voters is the lowest in Wyoming, and only 47.4% of Wyoming's population registered to vote.


### Contributions Distribution and Details
```{r, echo=FALSE}
# Read data
contributions1 <- readr::read_csv(here("data", "clean", "contribution_processed.csv"))

#head(contributions1)

#summary(contributions1)

# Factorize categorical variables
contributions1$committee_name <- as.factor(contributions1$committee_name)
```
```{r, message=FALSE, warning=FALSE, echo = FALSE, results = "asis"}
# Calculate the summary statistics of contributions by candidate
contr_sum <- contributions1 %>%
  select(committee_name,contribution_receipt_amount) %>%
  dplyr::group_by(committee_name) %>% 
  dplyr::summarise(number_of_contributions = n(),
                   total_raised_amount = sum(contribution_receipt_amount),
            mean_contribution = mean(contribution_receipt_amount, na.rm = T),
            median_contribution = median(contribution_receipt_amount, na.rm = T))

# Display in a table
knitr::kable(contr_sum, caption = "Contributions Summary by Candidate",
             col.names = c('Candidate name','Number of contributions',
                           'Total raised amount (US Dollars)',
                           'Mean contribution (US Dollars)','Median contribution (US Dollars)'),
             format.args = list(big.mark = ",", scientific = FALSE),
             digits = 2,align = "l",full_width = T)
```

```{r, fig.cap="Domestic Individual Contribution Distribution",echo=FALSE}
# Generate the boxplot
ggplot(contributions1, aes(x=contribution_receipt_amount, fill = committee_name), alpha=0.8) + 
  geom_boxplot() + 
  stat_boxplot(geom ='errorbar') +
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))+
  scale_fill_manual(name = "Committee name", values = c("dodgerblue3", "firebrick2"), 
                    labels = c("Joe Biden","Donald Trump")) +
  # formatting
  ggtitle("Contributions to Presidential Candidates of 2020 US Election",
          subtitle = "Domestic Individual Contribution Amounts Received in 2020 (log10 scaled)") +
  labs(y = "Candidate", x = "Contribution Amount ($)",caption = "Source: fec.gov") +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        plot.subtitle = element_text(face = "bold", color = "grey35"),
        plot.caption = element_text(color = "grey68"),
        legend.position="bottom",
        axis.text.y = element_blank())

```

To see more contribution details, we selected from the original data the domestic individual contributions with amounts higher than 200 dollars received by two presidential candidates. As shown in the contributions summary table, Biden received double the number of contributions and the total amounts of funds as Trump did, but the mean and median contributions to Trump are higher than to Biden. The log10 scaled boxplot above also demonstrates the difference in median contributions, and in addition, it shows that the contributions distributions for both candidates are largely right skewed with a good number of outliers. This makes sense as the majority of individuals contributed less than 500 dollars. 


### Contributions by Date: Time Series
```{r, echo=FALSE}
# Read the dataset
contribution_by_date <- readr::read_csv(here("data", "clean", "contribution_by_date.csv"))

# Convert format
contribution_by_date$contribution_receipt_date <-
  as_date(contribution_by_date$contribution_receipt_date)
contribution_by_date$committee_name <-
  as.factor(contribution_by_date$committee_name)

ts <- contribution_by_date[order(contribution_by_date$contribution_receipt_date, 
                                 decreasing= F),]

# Interactive time series plot with highcharter
ts %>%
  hchart("area",hcaes(x = contribution_receipt_date, y = Total, 
                      group = committee_name)) %>%
  hc_chart(zoomType = "x") %>%
  hc_colors(c("#0015BC", "#FF0000")) %>%
  hc_legend(align = "center", verticalAlign = "bottom",layout = "horizontal") %>%
  hc_xAxis(title = list(text = "Contribution Receipt Date"),
           labels = list(format = '{value:%b %d}')) %>%
  hc_yAxis(title = list(text = "Contribution Amount (US Dollars)"),
           tickInterval = 2000000,
           max = 14000000) %>%
  hc_title(text = "<b>Individual Contributions to Presidential Candidates 2020</b>") %>%
  hc_subtitle(text = "Click and drag in the plot area to zoom in") %>%
  hc_plotOptions(area = list(lineWidth = 0.5))
```

We also grouped data points by receipt date and calculated the daily raisings of each candidate from January 1, 2020 to October 15, 2020, which are shown the plot above. It is clear that Joe Biden generally raised more funds than Donald Trump. There was a small peak in raisings for Biden in the early March that paralleled Biden's win in the South Carolina Democratic presidential primary, which we learned from the [news](https://edition.cnn.com/2020/03/01/politics/joe-biden-south-carolina-fundraising-february-cnntv/index.html) of the time. 
More notably, Biden achieved success in fundraising from mid-August, and Biden's daily raisings hit the 13.6M dollars on August 20, 2020 by the time he [officially accepted the Democratic nomination](https://www.nytimes.com/2020/08/20/us/politics/Joe-Biden-accepts-democratic-nomination.html).
Although Donald Trump also received more funds in the second half year, the contributions to Trump did not significantly increase as the election season approached. 


### Contributor Occupations

To obtain more information about individual contributors, we extracted keywords in each contributor's occupation and divide by candidate, so that we were able to draw word clouds for each candidate.

```{r,echo=FALSE}
# To save time, read the saved .csv datasets
oc_biden_count <- readr::read_csv(here("data", "clean", "occupation_BIDEN_count.csv"))

oc_trump_count <- readr::read_csv(here("data", "clean", "occupation_TRUMP_count.csv")

  
# Wordcloud Biden
# Reference: https://www.r-graph-gallery.com/196-the-wordcloud2-library.html
pal_blue <- c("blue","#1F45FC","#2B60DE","#0000A0","#6698FF","#1589FF") #blue color palette
df_biden <- oc_biden_count
df_biden$freq <- (df_biden$freq)^(1/3) #scale the frequencies
```

#### *50 most popular occupations of contributors who supported Joe Biden*
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis"}
w1<- wordcloud2(df_biden, size = 0.4,
         maxRotation = 0, minRotation = 0,
         color=rep_len(pal_blue, nrow(df_biden)))
w1
library(htmlwidgets)
library(webshot)
saveWidget(w1,"w1.html",selfcontained = F)
#knitr::include_graphics("./w1.PNG")
```

To display words properly, the word size of the word cloud was scaled by extracting a cube root of the word frequency count. The above word cloud for Joe Biden clearly shows that a great proportion of contributors are not employed, and attorney, physician, engineer, and manager are also popular occupations.

#### *50 most popular occupations of contributors who supported Donald Trump*
```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis"}
# Wordcloud Trump
pal_red <- c("red","#F70D1A","#E77471","#F62217","#9F000F","#F75D59") #red color palette
df_trump <- oc_trump_count
df_trump$freq <- (df_trump$freq)^(1/3) #scale the frequencies

w2<- wordcloud2(df_trump, size = 0.4,
         maxRotation = 0, minRotation = 0,
         color=rep_len(pal_red, nrow(df_trump)))
w2
#saveWidget(w2,"w2.html",selfcontained = F)
#knitr::include_graphics("./w2.PNG")
```

Compared to the blue word cloud, this one for Trump has a smaller size consistent to a small total number of contributors. The most prominent word is Retired, which implies that contributors who supported Trump are dominantly retired. Besides, entrepreneur, owner, and manager are popular occupations. The actual frequency counts are shown in the following bar chart.

```{r, fig.height=5, echo=FALSE}
# Bar charts of contributor occupations

# Biden
g1<- oc_biden_count %>% head(10) %>% 
  ggplot(aes(x=reorder(oc_str_sp, freq, median), y=freq)) +
    geom_bar(stat="identity", fill="dodgerblue3") +
    geom_text(aes(label=freq), hjust=-0.05, size=3) +
    coord_flip() +
    ylim(0, 220000) +
    # formatting
    ggtitle("Joe Biden") +
    labs(y = "Frequency", x = "Contributor occupation",caption = " ") +
    theme_minimal() +
    theme(plot.title = element_text(size = 11, face = "bold", color = "grey35"),
        plot.caption = element_text(color = "grey68"))

# Trump
g2<- oc_trump_count %>% head(10) %>% 
  ggplot(aes(x=reorder(oc_str_sp, freq, median), y=freq)) +
    geom_bar(stat="identity", fill="firebrick2") +
    geom_text(aes(label=freq), hjust=-0.05, size=3) +
    coord_flip() +
    ylim(0, 155000) +
    # formatting
    ggtitle("Donald Trump") +
    labs(y = "Frequency", x = " ",caption = "Source: fec.gov") +
    theme_minimal() +
    theme(plot.title = element_text(size = 11, face = "bold", color = "grey35"),
        plot.caption = element_text(color = "grey68"))


# Plot in a grid
grid.arrange(g1, g2, ncol=2, nrow=1,
     top = textGrob("Contributions to Presidential Candidates of 2020 US Election\nContributor Occupation Distribution",gp=gpar(fontsize=13, fontface = "bold")))

```

Comparing difference between candidates, more than half of 10 top occupations of Joe Biden's contributors are legal or technical professional positions, whereas more than half of 10 top occupations of Donald Trump's contributors are jobs in business. 

## Disbursement Data Analysis
### Disbursement Distribution
```{r, message=FALSE, warning=FALSE}
exp_df <- readr::read_csv(here("data", "clean", "disbursement_processed.csv"))
exp_df$disbursement_date <- as.Date(exp_df$disbursement_date, format="%Y-%m-%d %H:%M:%S")
# Calculate the total disbursement by committee
disbursement_sum <- exp_df %>% 
  filter(committee_name == 'BIDEN FOR PRESIDENT' | committee_name == 'DONALD J. TRUMP FOR PRESIDENT, INC.') %>% 
  filter(disbursement_amount > 0)
  
# Generate the boxplot
ggplot(disbursement_sum, aes(x=disbursement_amount, y= committee_name, fill=committee_name), alpha=0.8) + 
  geom_boxplot(varwidth = TRUE) + 
  stat_boxplot(geom ='errorbar') + 
  scale_x_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x)))+
  scale_fill_manual(name = "Committee name", values = c("dodgerblue3", "firebrick2"), 
                    labels = c("Joe Biden","Donald Trump")) +
  labs(y = "Candidate", x = "Disbursement Amount",caption = "Source: fec.gov", 
       title="Disbursement Made by Presidential Committees of 2020 US Election",
       subtitle = "in US Dollar (log10 scaled)") +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        plot.subtitle = element_text(face = "bold", color = "grey35"),
        plot.caption = element_text(color = "grey68"),
        legend.position="bottom",
        axis.text.y = element_blank())
```


```{r}
disbursement_summary <- disbursement_sum %>%
  select(committee_name, disbursement_amount) %>%
  dplyr::group_by(committee_name) %>% 
  dplyr::summarise(number_of_records = n(),
                   total_disbursed_amount = sum(disbursement_amount),
            mean_disbursement = mean(disbursement_amount, na.rm = T),
            median_disbursement = median(disbursement_amount, na.rm = T))

# Display in a table
knitr::kable(disbursement_summary, caption = "Disbursement Summary by Candidate",
             col.names = c('Candidate name','Number of Records',
                           'Total disbursed amount (US Dollars)',
                           'Mean disbursement amount (US Dollars)','Median disbursement amount (US Dollars)'),
             format.args = list(big.mark = ",", scientific = FALSE),
             digits = 2,align = "l",full_width = T)
```
Every expenditure made by Trump Committee are evenly spread out from 0 to less than a million. The distribution is a little left skewed. There are more outliers clustering at the higher expenditure level than lower expenditure level. On the other hand, Biden Committee has their expenditure distribution centered symmetrically around their median. The range of Biden Committee's single expenditure is wider than Trump Committee. There are more outliers clustering at the higher expenditure level, which means Biden Committee's made more large transactions than Trump Committee. 


### Top 15 Presidential Campaign Made the Most Disbursement
```{r, message=FALSE, warning=FALSE}
# Calculate the total disbursement amount by committee (in million)
# Get the top 15 committee
com_exp <- exp_df %>%
  group_by(committee_name) %>% 
  summarize(total = round((sum(disbursement_amount) / 1e6), 2)) %>%
  arrange(desc(total)) %>% 
  slice(1:15) %>%
  ungroup()

# Find the corresponding Political Party for the committee
com_exp$PoliticalParty <- c('D', 'D', 'R', 'D', 'D','D', 'D', 'D', 'D', 'I','D', 'R', 'I', 'L', 'D')

# Factorize the Political Party Column
com_exp$PoliticalParty <- factor(com_exp$PoliticalParty, 
                              levels=c("D", "R", "I", "L"), 
                              labels=c("Democratic", "Republican", "Independent", "Libertarian"))

# Store the top 15 Committee and their party into a variable
top15_pp <- com_exp %>% select(c("committee_name", "PoliticalParty"))

# Generate the Interactive Cleveland Dot Plot
ggplot(com_exp, aes(x = total, y = reorder(committee_name, total), color=PoliticalParty, label=total)) +
  geom_point() + 
  geom_text(hjust=-0.2, size = 3) +
  scale_x_continuous(limits=c(1,1000)) +
  scale_color_manual(name = "Political Party", values = c("dodgerblue3", "firebrick2","mediumorchid4","gold2"), 
                    labels = c("Democratic","Republican", "Independent", "Libertarian")) +
  scale_y_discrete(labels=c('Kamala Harris','Jo Jorgensen','Brock Pierce','Roque De La Fuente','Cory Booker',
                            'Kanye West','John Delaney','Andrew Yang','Amy Klobuchar', 'Elizabeth Warren', 
                            'Bernie Sanders', 'Tom Steyer', 'Donald Trump', 'Joe Biden', 'Mike Bloomberg')) +
  labs(x = "Total Expenditure (Million $)", y = "Candidate", caption = "Source: fec.gov", 
       title ="Top 15 Presidential Campaign Made the Most Disbursement", 
       subtitle = "2020 Presidential Election (Rounded to 2 Digits)") + 
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        plot.subtitle = element_text(face = "bold", color = "grey35"),
        plot.caption = element_text(color = "grey68"),
        legend.position="bottom")
```

The above graph shows 15 committees with the most disbursement made. Among these 15 committees, 10 of them are Democrates, 2 of them are Republicans, and 2 of them are Independent, 1 of them is Libertarian. One interesting finding is that Mike Bloomberg's Committee spend the most among all of the committees. This is not expected since Bloomberg quit the election race early in March 2020. Joe Biden's committee and Donald Trump's committee gets the second and third place on the list, and this is what is expected since they are the main candidates in this election. We can see that this distribution is following an exponential trend. Each committee spends twice more than the committee that is ranked after it. 

### Disbursement Details
```{r, message=FALSE, warning=FALSE, fig.width=15, fig.height=8}
exp_perc <- exp_df %>% 
  filter(exp_df$committee_name %in% com_exp$committee_name & exp_df$disbursement_purpose_category != "REFUNDS") %>% 
  group_by(committee_name, disbursement_purpose_category) %>% 
  summarise(total = sum(disbursement_amount)) %>%
  mutate(Freq = 100 * total / sum(total)) %>%
  arrange(committee_name)

exp_perc <- pivot_wider(exp_perc, 
            id_cols=committee_name, 
            names_from=disbursement_purpose_category,
            values_from = Freq)
exp_perc$committee_name <- factor(exp_perc$committee_name)
exp_perc[is.na(exp_perc)] <- 0

exp_perc %>%
  ggparcoord(columns = c(2:9,11:13,10),
             groupColumn = 1,
             showPoints = T,
             scale = "globalminmax",
             mapping=aes(color=committee_name)
             ) + 
  scale_color_viridis_d("Committee",labels=levels(exp_perc$committee_name)) +
  labs(x = "Expenditure Category", y = "Percentage of Total Expenditure", caption = "Source: fec.gov", 
       title ="2020 Presidential Election Disbursement Break Down",
       subtitle="Excluding Refunds") + 
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        plot.subtitle = element_text(face = "bold", color = "grey35"),
        plot.caption = element_text(color = "grey68"),
        legend.position="bottom")
```

The three areas that most of the committees focus on are Administrative, Advertising, and Consulting. Those categories are which the services could be provided virtually. Compare to those categories, disbursements in Travel, Events, and Materials are relatively low. Since those categories require in-person meetings and activities, this trend could be caused by the COVID pandemics this year. After investigating the above graph in an interactive plot, there is no obvious correlation between each pair of the disbursement categories listed above. So we will not include the interactive parallel plot explicitly here. 

### When does those committee spend the most?
#### Spending Trend of Two Major Committees
```{r, message=FALSE, warning=FALSE}
biden_Trend <- exp_df %>% 
  filter(committee_name == "BIDEN FOR PRESIDENT" & disbursement_amount > 0)
biden_Trend <- aggregate(biden_Trend$disbursement_amount,
                         by=list(lubridate::floor_date((biden_Trend$disbursement_date), "week")), 
                         sum)
biden_Trend$x <- 100 * biden_Trend$x / sum(biden_Trend$x)
biden_Trend$Committee <- "BIDEN FOR PRESIDENT"

trump_Trend <- exp_df %>% 
  filter(committee_name == "DONALD J. TRUMP FOR PRESIDENT, INC." & disbursement_amount > 0)

trump_Trend <- aggregate(trump_Trend$disbursement_amount,
                         by=list(lubridate::floor_date((trump_Trend$disbursement_date), "week")), 
                         sum)

trump_Trend$x <- 100 * trump_Trend$x / sum(trump_Trend$x)
trump_Trend$Committee <- "DONALD J. TRUMP FOR PRESIDENT, INC."

ggplot(rbind(biden_Trend, trump_Trend),
       aes(x=Group.1, y=x, color=Committee)) +
  geom_point() + 
  geom_line() + 
  geom_line(stat = "smooth", method = "loess", alpha = 0.5) + 
  scale_x_date(labels = date_format("%m-%d"), 
               limits = c(min=as.Date("2020-01-01"), max=as.Date("2020-11-04")), 
               breaks = date_breaks("2 week")) + 
  scale_y_continuous(limits=c(0,15)) +
  scale_color_manual(values=c("dodgerblue3", "firebrick2")) + 
  labs(x = "Date", y = "Percent of Committee's Disbursement", caption = "Source: fec.gov", 
       title = "Percent of Total Disbursements Made by Presidential Committee per Day",
       subtitle = "2020 Presidential Election") +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        plot.subtitle = element_text(face = "bold", color = "grey35"),
        plot.caption = element_text(color = "grey68"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="bottom")
```

From the above graph, we can see both of the committees are spending more and more as election day approaches.Th ere are some spending trend fluctuation in early 2020, but such fluctuation evens out as time goes on. Trump's committee started earlier than Biden's committee to invest money in activities regards this election. We can see this in the part of trend in January and the mass investment starting in April. Trump's committee spending trend has three peaks in the graph, which are in January, late May to early July, and late September to early October. On the other hand, Biden's committee started their disbursement later but the total disbursement grows more rapidly. There are two obvious peak in Biden's committee's spending trend line, which are in May and late September to early October.

### Disbursement Recipient Share 
```{r, message=FALSE, warning=FALSE, fig.width=15, fig.height=10}
# Calculate the total disbursement received by recipients
recipients_df <- exp_df %>% 
  group_by(disbursement_purpose_category, recipient_name) %>% 
  summarise(value = sum(disbursement_amount)) %>%
  arrange(disbursement_purpose_category, desc(value))
recipients_df <- filter(recipients_df, value > 0)

# select top 10 recipients among each disbursement category
top10_recipients <- recipients_df %>% 
  arrange(disbursement_purpose_category, desc(value)) %>% 
  group_by(disbursement_purpose_category) %>% 
  slice(1:10)


# Graph Treemap based on the top 10 recipients among each category
dout <- data_to_hierarchical(data = top10_recipients, 
           group_vars=c("disbursement_purpose_category","recipient_name"),
           size_var = "value") 
hchart(dout, type="treemap", allowTraversingTree=TRUE) %>%
  hc_title(text = "<b>Major Disbursement Recipients in Each Category</b>") %>%
  hc_tooltip(pointFormat = "<b>{point.name}</b>:<br>
                            Total (US Dollar): {point.value:,.0f}")
```
This graph matches what we have discovered before. Most of the committees focus on advertising to help them win the election. Media Assembly and Media Buying & Analytics.LLC are two major companies that provides media advertising services to the 2020 election. As expected, there are also some large tech companies like Google and Facebook in this section. There are also many disbursements for administrative and consulting purposes. Administrative and consulting are the next two largest sectors. They get about equal share of the total disbursements. Zenefits, Vensure HR.LLC, ADP.LLC are three major recipients in the Administrative section. All of these three companies provides Human Resource supports such as H.R. Management software system. In the Consulting section, we see data analytics and financial consulting companies such as Hawkfish.LLC and Geller & Company.LLC. In Other section, there are banks, tech service companies, as well as Vensure HR.LLC and Hawkfish.LLC that we have seen earlier. Though we are unable to specify which purpose those disbursements are for, it is highly likely that those disbursements would be related to financial and other minor transactions regarding the services committees purchased from those supporting companies. 

### Where Does All of The Disbursement Money Go?
We are going to visualize the disbursement distribution across the 50 states in U.S in the next step:
```{r,  message=FALSE, warning=FALSE,fig.width=10, fig.height=6}
data("usgeojson", package = "highcharter")
# Calculate Total Amount of Disbursement Received for Each Location
state_total <- exp_df %>% 
  group_by(recipient_state) %>% 
  summarise(value= sum(disbursement_amount))

state_total$recipient_state <- state.name[match(state_total$recipient_state, state.abb)]
state_total <- state_total[complete.cases(state_total), ]

highchart(type="map") %>%
hc_title(text = "Total Disbursements By All Presidential Candidates 2020 By State") %>%
  hc_subtitle(text = "Double click the state area to zoom in") %>%
  hc_add_series_map(usgeojson, state_total,
    name = "Total Disbursements",
    value = "value", joinBy = c("woename", "recipient_state"),
    dataLabels = list(
       enabled = TRUE,
       format = "{point.properties.postalcode}"
     ),
    tooltip = list(
      valueDecimals = 0,
      valuePrefix = "$",
      valueSuffix = " USD"
     )
   ) %>%
   hc_colorAxis(minColor = "white", maxColor = "red") %>%
   hc_legend(valueDecimals = 0, valueSuffix = "%") %>%
   hc_mapNavigation(enabled = TRUE)
```
Disbursement mainly goes towards the companies on the Southern and Northern-East Side of the United States. This result is consistent to [2019 Q4 U.S Real GDP data](https://apps.bea.gov/iTable/iTable.cfm?reqid=70&step=30&isuri=1&major_area=0&area=xx&year=2019&tableid=532&category=5532&area_type=0&year_end=-1&classification=non-industry&state=0&statistic=1&yearbegin=-1&unit_of_measure=levels) reported by the Bureau of Economic Analysis.Those states that are highlighted in dark blue are the states that contribute the most to the U.S's GDP. Compare to the 2020 election result, all of these states that contributes the most to the U.S total GDP, besides Taxas, voted for Joe Biden. Such pattern discontinued as we move down along the GDP level. Since the graph above includes a majority of social media and network companies, which their services can be done remotely, it would not reflect which state the candidates are focusing on to perform actions that help win the votes. On the other hand, there are two disbursement categories called `MATERIALS` and `EVENTS` that consists of the physical materials that are purchased and used locally for this presidential election, such as posters, staging materials, delivery fee, etc. If we look at the disbursement distribution across the 50 U.S. states on those categories, we might get a better idea on our previous question. In corresponding to the voting result analysis, let's focus on the two main candidates' committees.

```{r, message=FALSE, warning=FALSE,fig.width=20, fig.height=6}
# Disbursement Flow for Joe Biden's Main Committee
target_exp <- exp_df  %>%
  filter((committee_name == "BIDEN FOR PRESIDENT" | committee_name == "DONALD J. TRUMP FOR PRESIDENT, INC") &
          disbursement_purpose_category == "EVENTS" | disbursement_purpose_category == "MATERIALS")
target_exp$recipient_state <- state.name[match(target_exp$recipient_state, state.abb)]
target_exp <- target_exp[complete.cases(target_exp$recipient_state), ]
  
# Compute amount of Biden committee disbursement per category and state 
exp_flow_B <- target_exp %>%
  filter(committee_name == "BIDEN FOR PRESIDENT") %>%
  group_by(recipient_state) %>%
  summarise(value = sum(disbursement_amount))

# Graph Highchart
highchart(type="map") %>%
hc_title(text = "Total Disbursements By 2020 Joe Biden Committee By State") %>%
  hc_subtitle(text = "Double click the state area to zoom in") %>%
  hc_add_series_map(usgeojson, exp_flow_B,
    name = "Total Disbursements",
    value = "value", joinBy = c("woename", "recipient_state"),
    dataLabels = list(
       enabled = TRUE,
       format = "{point.properties.postalcode}"
     ),
    tooltip = list(
      valueDecimals = 0,
      valuePrefix = "$",
      valueSuffix = " USD"
     )
   ) %>%
   hc_colorAxis(minColor = "white", maxColor = "red") %>%
   hc_legend(valueDecimals = 0, valueSuffix = "%") %>%
   hc_mapNavigation(enabled = TRUE)
```


```{r, message=FALSE, warning=FALSE,fig.width=20, fig.height=6}
# Same steps for Trump's Main committee
# Compute amount of Biden committee disbursement per category and state 
exp_flow_T <- target_exp %>%
  filter(committee_name == "DONALD J. TRUMP FOR PRESIDENT, INC.") %>%
  group_by(recipient_state) %>%
  summarise(value = sum(disbursement_amount))

# Graph Highchart
highchart(type="map") %>%
hc_title(text = "Total Disbursements By 2020 Donald Trump Committee By State") %>%
  hc_subtitle(text = "Double click the state area to zoom in") %>%
  hc_add_series_map(usgeojson, exp_flow_T,
    name = "Total Disbursements",
    value = "value", joinBy = c("woename", "recipient_state"),
    dataLabels = list(
       enabled = TRUE,
       format = "{point.properties.postalcode}"
     ),
    tooltip = list(
      valueDecimals = 0,
      valuePrefix = "$",
      valueSuffix = " USD"
     )
   ) %>%
   hc_colorAxis(minColor = "white", maxColor = "red") %>%
   hc_legend(valueDecimals = 0, valueSuffix = "%") %>%
   hc_mapNavigation(enabled = TRUE)
```

There are not a lot of physical events going on and propaganda passing out for this year's election. Partly it could due to the COVID pandemic. From the above graph, the location where Trump's committee held physical events are more widely spread out across U.S than Biden's committee, while the recipients of material and event fee made by Biden's committee mainly clustered in the east half of the U.S. and West Coast. As shown previously in the parallel axis graph, both of the committees spent less than 1% of their total expenditure in Materials and Events. Compare both maps above, we can see some regions colored in bright green and blue in the map on the right hand side, but not the map on the left hand side. Those bright colors represent that those regions are receiving more of such committee's total disbursement. The two maps are colored based on the same color scale. Since we have found that Biden's committee spent more than Trump's Committee, and Trump's committee is spending more in the above two areas, it is not difficult to conclude that Trump's committee spent a larger percent of their total expenditure in physical events. This could be one of the campaign's strategy. Also, Trump's committee is spending significantly more on some of the states where they win compare to the expenditure of Biden's committee on those states. There is such a trend in the election result this year, but to answer whether there is truly a correlation between expenditure and the voting results would need further investigations on more data sets from previous years.

<!--chapter:end:05-results.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Interactive component


## Disbursement Data Interactive Plot

The above graph shows the Disbursement Trends of the 15 Presidential Committees that made the most disbursements. Each data point represents the rolling sum of a committee's total disbursement settled at the end of a week. The dot will be colored in grey after the candidate suspended the committee. We manipulated the cleaned datasets to extract the information needed to make this graph. The dataset is uploaded to Github and can be founded [here](https://github.com/NeverGiveUpDXQ/2020-U.S.-Election-Visualizations/tree/wz/data/d3csv).

**Instructions to Use the Graph**

1. Users can drag on the canvas along the y-Axis to zoom into specific ranges.
2. Users can double click on the canvas to reset the y-Axis.
3. Users can hover mouse on each dot to see exact disbursement value, date, and candidate information.
4. Users can click on the dot to toggle display/fade each trend line.

<iframe src="https://vizhub.com/wz2536/1369d9b47bfe47289f5929619171858b?mode=embed" title="D3 Disbursement analysis" height="450" width="750"></iframe>

Reference:

1. D3.js Graph Gallery: Line chart with zoom in d3.js (https://www.d3-graph-gallery.com/graph/line_brushZoom.html)
2. D3.js Graph Gallery: Connected scatter plot with interactive legend (https://www.d3-graph-gallery.com/graph/connectedscatter_legend.html)

<!--chapter:end:06-interactive.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Conclusion


<!--chapter:end:07-conclusion.Rmd-->

